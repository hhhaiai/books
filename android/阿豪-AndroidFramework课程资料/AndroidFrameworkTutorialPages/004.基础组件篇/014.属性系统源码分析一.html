<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Android Framework</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css" as="style"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/app.6bee58ca.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" as="script"><link rel="preload" href="/AndroidFrameworkTutorialPages/assets/js/130.244b0cdc.js" as="script"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/10.337b766a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/100.72736f69.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/101.5f94d145.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/102.d46507a2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/103.62bc736d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/104.094e7d39.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/105.8649bab5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/106.f4471270.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/107.a4d0d98b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/108.fa147bd9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/109.adf77d95.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/11.be2e0167.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/110.94967d09.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/111.e03020fe.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/112.4873c818.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/113.03968f51.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/114.b3acbb7e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/115.7d741a08.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/116.bed9a972.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/117.5fa3c703.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/118.1cb82fbd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/119.1e42a517.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/120.5cab3fee.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/121.5ebf516c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/122.9fa61bb5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/123.68670591.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/124.e20797c4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/125.afb2f74f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/126.5ee1833a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/127.99b668fe.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/128.31cc5a62.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/129.c4c6f153.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/131.b04bca8c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/132.26b04438.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/133.6d4105f9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/134.3caa2583.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/135.f16ec1d8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/136.bce7a620.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/137.89783106.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/138.844df1ed.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/139.9bd06dde.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/14.7d944ea8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/140.47e0612e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/141.bcb89b7d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/142.fa77e5f5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/143.2133b57d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/144.1c5718b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/145.6b778a66.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/146.65d0ba21.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/147.cc848d93.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/148.0d48f820.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/149.1bfabe32.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/15.bf19b574.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/150.d226e17b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/151.683cee30.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/152.1e08bc9f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/153.7b036048.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/154.f4427860.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/155.97b58f86.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/156.6253030d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/157.c4b2705a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/158.e56ee3bf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/159.8bdf5bf9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/16.91ebb564.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/160.31a5c38a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/161.442baa69.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/162.ace1371b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/163.c045adf7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/164.130ddeb6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/165.ba5e3166.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/166.05cbc08a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/167.d3af2d93.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/168.28e4a86e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/169.b5534740.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/17.bfe50ee3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/170.b9f8ce6c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/171.2e5062ac.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/172.d41cb3be.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/173.7fd57dd2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/174.c5711ef1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/175.35e58f60.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/176.5c3a823b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/177.9f0c01b8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/178.db5f56e3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/179.3cba5445.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/18.05ccfb53.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/180.9421ca90.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/181.d2432935.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/182.ad8fe591.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/183.ef903b97.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/184.7e7614df.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/185.247ca305.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/186.1c9d067f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/187.8b4406b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/188.54e1c445.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/189.611a92d3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/19.afa41ba1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/190.34f0b0ac.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/191.bf8f6578.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/192.0a98e607.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/193.fcd95338.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/194.e896bffb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/195.994ef040.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/196.107f6daf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/197.2eace9c7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/198.8f28f24e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/199.896f5c51.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/20.e9510ad7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/200.20e5fa81.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/201.1f836eb2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/202.3c04816c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/203.f1654ace.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/204.32e15ed6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/205.18d27ec0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/206.952ebb9b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/207.6a0fb53c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/208.10771e83.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/209.d113ff5b.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/21.86ad6466.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/210.ca14ba8f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/211.949c32ac.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/212.0dfb85d8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/213.9b8200d8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/214.3e51b142.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/215.cdd786a4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/216.c8e67636.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/217.687d3ea6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/218.f37711a3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/219.e12c93a8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/22.09086018.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/220.89e4ec6e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/221.02367691.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/222.e5db60ae.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/223.151e46b9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/224.3c5c08e9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/225.a10a3689.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/226.dc6cf592.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/227.5d484f21.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/228.32831b10.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/229.263fbcc1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/23.62e146ab.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/230.7e5f6ff9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/24.36df6bff.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/25.99201ee4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/26.0dad3cd4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/27.be36597a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/28.4a19ff25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/29.5c2b113e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/3.97bbbdc8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/30.38a9b8bb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/31.0d5a08c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/32.804ecc25.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/33.a8e71e21.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/34.da185bf8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/35.e45072d9.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/36.b81c8de2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/37.f26d2d52.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/38.3d72fa2e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/39.8de59f74.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/4.983d15c3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/40.9a73323f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/41.42900ccd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/42.10a23b66.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/43.4f3cf1ea.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/44.8dc2b0d6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/45.76ee68b3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/46.24ca3ec6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/47.ce306e3f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/48.594e18b2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/49.1ac45e0a.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/5.574f6fbb.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/50.5cf1e47d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/51.037e5442.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/52.141d9248.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/53.6b1fbef2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/54.e55084df.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/55.9e651b61.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/56.ac520841.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/57.63b15773.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/58.feb843a2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/59.9d66b37d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/6.a4122f72.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/60.a8c87ab2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/61.5f078d82.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/62.3a0f4d59.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/63.8c484ea1.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/64.cc875fce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/65.82180ec7.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/66.2eb988a8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/67.8308704f.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/68.746ae2c4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/69.d429f413.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/70.0f287cf2.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/71.e5e79631.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/72.caa5fa2e.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/73.8eee8534.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/74.442758f4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/75.039e0439.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/76.a8b36acd.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/77.fe077be8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/78.c7b893c0.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/79.2593cbe8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/8.9d6eb8a6.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/80.d01aa2ae.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/81.c35e3eaf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/82.7438991c.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/83.72e120f5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/84.d4092596.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/85.7bd957ce.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/86.68aca8a4.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/87.34fa1f22.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/88.2c8a64b8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/89.02b77ecc.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/9.bee9eff5.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/90.58a2ef63.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/91.04b48f98.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/92.b0369a2d.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/93.8b05fefe.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/94.97bbf0f3.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/95.57a85eaf.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/96.df8ce9d8.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/97.f39c40ea.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/98.2d6a15af.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/99.d3f9e663.js"><link rel="prefetch" href="/AndroidFrameworkTutorialPages/assets/js/vendors~docsearch.833ce4c0.js">
    <link rel="stylesheet" href="/AndroidFrameworkTutorialPages/assets/css/0.styles.ec7aed17.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Android Framework</h3> <p class="description" data-v-59e6cb88></p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/AndroidFrameworkTutorialPages/" class="home-link router-link-active"><!----> <span class="site-name">Android Framework</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>177</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <!----> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习路线与指南</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>玩转AOSP篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学穿Binder篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>基础组件篇</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/001.Android 平台智能指针使用与分析.html" class="sidebar-link">1.Android 平台智能指针使用与分析</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/002.弱引用 wp 的作用.html" class="sidebar-link">2.弱引用 wp 的作用</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/003.Linux eventfd 原理与实践.html" class="sidebar-link">3.Linux eventfd 原理与实践</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/004.Linux IO 多路复用 epoll 机制.html" class="sidebar-link">4.Linux IO 多路复用 epoll 机制</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/005.Linux timerfd 的基本使用.html" class="sidebar-link">5.Linux timerfd 的基本使用</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/006.Android Native Looper 机制.html" class="sidebar-link">6.Android Native Looper 机制</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/007.Android Java Looper 机制.html" class="sidebar-link">7.Android Java Looper 机制</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/008.Handler 同步屏障机制.html" class="sidebar-link">8.Handler 同步屏障机制</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/009.IdleHanlder 原理与使用.html" class="sidebar-link">9.IdleHanlder 原理与使用</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/010.属性系统入门.html" class="sidebar-link">10.属性系统入门</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/011.属性文件生成过程分析.html" class="sidebar-link">11.属性文件生成过程分析</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/012.如何添加系统属性.html" class="sidebar-link">012.如何添加系统属性</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/013.属性与 Selinux.html" class="sidebar-link">013.属性与 Selinux</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/014.属性系统源码分析一.html" class="active sidebar-link">014.属性系统源码分析一</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/015.属性系统源码分析二.html" class="sidebar-link">015.属性系统源码分析二</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/016.属性系统源码分析三.html" class="sidebar-link">016.属性系统源码分析三</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/017.Unix Domain Socket 使用解析之 UDP 篇.html" class="sidebar-link">017.Unix Domain Socket 使用解析之 UDP 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/018.Unix Domain Socket 使用解析之 TCP 篇.html" class="sidebar-link">018.Unix Domain Socket 使用解析之 TCP 篇</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/019.Android 中的 Unix Domain Socket 使用解析.html" class="sidebar-link">019.Android 中的 Unix Domain Socket 使用解析</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/020.socketpair 使用解析.html" class="sidebar-link">020.socketpair 使用解析</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/021.Android 平台日志系统整体框架.html" class="sidebar-link">021.Android 平台日志系统整体框架</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/022.logd 守护进程初始化过程.html" class="sidebar-link">022.logd 守护进程初始化过程</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/023.客户端写日志过程分析.html" class="sidebar-link">023.客户端写日志过程分析</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/024.logd 写日志过程分析一.html" class="sidebar-link">024.logd 写日志过程分析一</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/025.logd 写日志过程分析二.html" class="sidebar-link">025.logd 写日志过程分析二</a></li><li><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/026.logd 读日志过程分析.html" class="sidebar-link">026.logd 读日志过程分析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统启动篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>应用层框架篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hal 与硬件服务篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>图形系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>输入系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统应用篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>构造系统篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目实战</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title"></h1> <div data-v-8a445198><!----> <!----> <i class="iconfont reco-eye" data-v-8a445198><span id="/AndroidFrameworkTutorialPages/004.%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6%E7%AF%87/014.%E5%B1%9E%E6%80%A7%E7%B3%BB%E7%BB%9F%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%80.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="·-title-属性系统源码分析一author-阿豪date-2023-11-10"><a href="#·-title-属性系统源码分析一author-阿豪date-2023-11-10" class="header-anchor">#</a> ·---
title:  属性系统源码分析一
author: 阿豪
date: '2023-11-10'</h2> <p>这是一个介绍 Android 属性系统的系列文章:</p> <ul><li>Android 属性系统入门</li> <li>属性文件生成过程分析</li> <li>如何添加系统属性</li> <li>属性与 SeLinux</li> <li>属性系统源码分析一（本文）</li> <li>属性系统源码分析二</li> <li>属性系统源码分析三</li></ul> <p>本文基于 AOSP android-10.0.0_r41 分支讲解</p> <h2 id="_1-属性系统整体架构"><a href="#_1-属性系统整体架构" class="header-anchor">#</a> 1. 属性系统整体架构</h2> <ul><li>Android 系统启动时会从若干属性配置文件中加载属性内容，所有属性（key/value）和属性安全上下文信息会存入 <code>/dev/__property__</code> 下的各个文件中。</li> <li>系统中的各个进程会通过 mmap 将 <code>/dev/__property__</code> 下的各个文件映射到自己的内存空间，这样就可以直接读取属性内容了</li> <li>系统中只有 init 进程可以<strong>直接</strong>写属性值，其他进程不能直接修改属性值</li> <li>init 进程启动了一个 Socket 服务端，一般称为 Property Service，其他进程通过 socket 方式，向 Property Service 发出属性修改请求。</li> <li><code>/dev/__property__</code>目录下文件中的数据会以字典二叉混合树的形式进行组织。</li></ul> <p>属性系统的整体架构如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/stingerzou/MyImages//20231127142708.png" alt=""></p> <p>接下来会从两个方面解析整个属性系统：</p> <ul><li>属性系统初始化过程</li> <li>属性系统的使用过程</li></ul> <h2 id="_2-属性系统初始化过程之-property-info-文件生成过程分析"><a href="#_2-属性系统初始化过程之-property-info-文件生成过程分析" class="header-anchor">#</a> 2. 属性系统初始化过程之 property_info 文件生成过程分析</h2> <h3 id="_2-1-整体流程"><a href="#_2-1-整体流程" class="header-anchor">#</a> 2.1 整体流程</h3> <p>属性系统是在 init 进程中初始化的，大致可以分为以下几步：</p> <ul><li>生成 property_info 文件</li> <li>在 <code>/dev/__properties__</code> 目录下生成每个属性对应的文件</li> <li>加载各个分区中的属性配置文件</li></ul> <p>接下来我们就先分析生成 property_info 文件的过程：</p> <p>内核启动后，第一个启动的进程是 init，对应到的代码是 <code>system/core/init/init.cpp</code> 中的 main 函数，该函数会调用到 SecondStageMain 函数，SecondStageMain 函数进一步调用到 property_init()，该函数用于属性系统的初始化：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">property_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 创建 /dev/__properties__ 文件夹</span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/__properties__&quot;</span><span class="token punctuation">,</span> S_IRWXU <span class="token operator">|</span> S_IXGRP <span class="token operator">|</span> S_IXOTH<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 生成 /dev/__properties__/property_info 文件</span>
    <span class="token function">CreateSerializedPropertyInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 生成属性文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__system_property_area_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to initialize property area&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这里应该是重复了，新版本代码已经删除</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>property_info_area<span class="token punctuation">.</span><span class="token function">LoadDefaultPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Failed to load serialized property info file&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这个函数流程很清晰：</p> <ul><li>mkdir 函数会创建好 <code>/dev/__properties__</code> 文件夹</li> <li>接着调用 <code>CreateSerializedPropertyInfo()</code> 函数加载安全上下文信息，序列化操作后保存到
<code>/dev/__properties__/property_info</code> 文件中</li> <li>然后调用 <code>__system_property_area_init()</code> 函数，在 <code>/dev/__properties__</code> 目录下创建每个安全上下文对应的属性文件</li> <li>最后调用 <code>LoadDefaultPath</code> 函数，加载属性值，并把属性值写入属性文件</li></ul> <p>目前主要分析 <code>CreateSerializedPropertyInfo()</code> 的过程：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">CreateSerializedPropertyInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">auto</span> property_infos <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>PropertyInfoEntry<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将各个分区的 property_contexts 加载进动态数组 vector&lt;PropertyInfoEntry&gt; property_infos 中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&quot;/system/etc/selinux/plat_property_contexts&quot;</span><span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/system/etc/selinux/plat_property_contexts&quot;</span><span class="token punctuation">,</span>
                                      <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Don't check for failure here, so we always have a sane list of properties.</span>
        <span class="token comment">// E.g. In case of recovery, the vendor partition will not have mounted and we</span>
        <span class="token comment">// still need the system / platform properties to function.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/vendor/etc/selinux/vendor_property_contexts&quot;</span><span class="token punctuation">,</span>
                                      <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Fallback to nonplat_* if vendor_* doesn't exist.</span>
            <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/vendor/etc/selinux/nonplat_property_contexts&quot;</span><span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&quot;/product/etc/selinux/product_property_contexts&quot;</span><span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/product/etc/selinux/product_property_contexts&quot;</span><span class="token punctuation">,</span>
                                     <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&quot;/odm/etc/selinux/odm_property_contexts&quot;</span><span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/odm/etc/selinux/odm_property_contexts&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/plat_property_contexts&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/vendor_property_contexts&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Fallback to nonplat_* if vendor_* doesn't exist.</span>
            <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/nonplat_property_contexts&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/product_property_contexts&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token string">&quot;/odm_property_contexts&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_infos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> serialized_contexts <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> error <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 序列化  vector&lt;PropertyInfoEntry&gt; -&gt; String</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">BuildTrie</span><span class="token punctuation">(</span>property_infos<span class="token punctuation">,</span> <span class="token string">&quot;u:object_r:default_prop:s0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serialized_contexts<span class="token punctuation">,</span><span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Unable to serialize property contexts: &quot;</span> <span class="token operator">&lt;&lt;</span> error<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//序列化后的 String 写入文件 /dev/__properties__/property_info</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> kPropertyInfosPath<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;/dev/__properties__/property_info&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteStringToFile</span><span class="token punctuation">(</span>serialized_contexts<span class="token punctuation">,</span> kPropertyInfosPath<span class="token punctuation">,</span> <span class="token number">0444</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Unable to write serialized property infos to file&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">selinux_android_restorecon</span><span class="token punctuation">(</span>kPropertyInfosPath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p><code>CreateSerializedPropertyInfo()</code> 函数可以分为三个阶段:</p> <ul><li>通过 <code>LoadPropertyInfoFromFile</code> 把各个分区中的属性 SeLinux 配置文件加载进内存中</li> <li><code>BuildTrie</code> 函数根据上一步加载的数据构建一个字典树，并序列化为一个 std::string 对象</li> <li>把上一步的序列化字符串写入 <code>/dev/__properties__/property_info</code> 文件</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages/img/20231029092550.png" alt=""></p> <p>接下来我们逐步分析。</p> <h3 id="_2-2-loadpropertyinfofromfile-加载属性-selinux-配置过程"><a href="#_2-2-loadpropertyinfofromfile-加载属性-selinux-配置过程" class="header-anchor">#</a> 2.2 LoadPropertyInfoFromFile 加载属性 SeLinux 配置过程</h3> <p>我们在系统源码中配置的属性相关的 SeLinux 信息会被编译进各个分区的 property_contexts 文件中，property_contexts 文件中的内容基本都是如下这样：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>persist.bluetooth.btsnoopenable u:object_r:exported_bluetooth_prop:s0 exact bool
persist.config.calibration_fac u:object_r:exported3_default_prop:s0 exact string
persist.dbg.volte_avail_ovr u:object_r:exported3_default_prop:s0 exact int
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>里面有属性名、属性安全上下文、exact、类型等信息。</p> <p>在 CreateSerializedPropertyInfo 函数中会多次调用 LoadPropertyInfoFromFile 函数，将各个分区中 property_contexts 文件中的内容加载进动态数组 vector&lt;PropertyInfoEntry&gt; property_infos 中。</p> <p>我们先看下 PropertyInfoEntry 结构体：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">PropertyInfoEntry</span> <span class="token punctuation">{</span>
  <span class="token function">PropertyInfoEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">U</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">V</span><span class="token operator">&gt;</span>
  <span class="token function">PropertyInfoEntry</span><span class="token punctuation">(</span>T<span class="token operator">&amp;&amp;</span> name<span class="token punctuation">,</span> U<span class="token operator">&amp;&amp;</span> context<span class="token punctuation">,</span> V<span class="token operator">&amp;&amp;</span> type<span class="token punctuation">,</span> <span class="token keyword">bool</span> exact_match<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">name</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">context</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>U<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">type</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>V<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">exact_match</span><span class="token punctuation">(</span>exact_match<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string context<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string type<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> exact_match<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>结构体比较简单，四个成员依次对应 property_contexts 文件中的四部分信息。</p> <p>接着看怎么加载的：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token function">LoadPropertyInfoFromFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> filename<span class="token punctuation">,</span>
                              std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PropertyInfoEntry<span class="token operator">&gt;</span><span class="token operator">*</span> property_infos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> file_contents <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将文件内容读取到字符串中，</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadFileToString</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_contents<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Could not read properties from '&quot;</span> <span class="token operator">&lt;&lt;</span> filename <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> errors <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> require_prefix_or_exact <span class="token operator">=</span> <span class="token function">SelinuxGetVendorAndroidVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> __ANDROID_API_R__<span class="token punctuation">;</span>

    <span class="token comment">// 解析字符串</span>
    <span class="token function">ParsePropertyInfoFile</span><span class="token punctuation">(</span>file_contents<span class="token punctuation">,</span> require_prefix_or_exact<span class="token punctuation">,</span> property_infos<span class="token punctuation">,</span> <span class="token operator">&amp;</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Individual parsing errors are reported but do not cause a failed boot, which is what</span>
    <span class="token comment">// returning false would do here.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> error <span class="token operator">:</span> errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Could not read line from '&quot;</span> <span class="token operator">&lt;&lt;</span> filename <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;': &quot;</span> <span class="token operator">&lt;&lt;</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>ReadFileToString 将文件中的内容加载到 file_contents 字符串中</li> <li>接着调用 ParsePropertyInfoFile 解析字符串中的内容</li></ul> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// 将字符串按行分割，接着将每一行的信息放入到 PropertyInfoEntry 结构体中。</span>
<span class="token keyword">void</span> <span class="token function">ParsePropertyInfoFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> file_contents<span class="token punctuation">,</span> <span class="token keyword">bool</span> require_prefix_or_exact<span class="token punctuation">,</span>
                           std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PropertyInfoEntry<span class="token operator">&gt;</span><span class="token operator">*</span> property_infos<span class="token punctuation">,</span>
                           std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token operator">*</span> errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Do not clear property_infos to allow this function to be called on multiple files, with</span>
  <span class="token comment">// their results concatenated.</span>
  errors<span class="token operator">-&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//按行分割并遍历</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> line <span class="token operator">:</span> <span class="token function">Split</span><span class="token punctuation">(</span>file_contents<span class="token punctuation">,</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> trimmed_line <span class="token operator">=</span> <span class="token function">Trim</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 过滤空行和注释行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trimmed_line<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">StartsWith</span><span class="token punctuation">(</span>trimmed_line<span class="token punctuation">,</span> <span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> property_info_entry <span class="token operator">=</span> PropertyInfoEntry<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> parse_error <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 解析每一行数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ParsePropertyInfoLine</span><span class="token punctuation">(</span>trimmed_line<span class="token punctuation">,</span> require_prefix_or_exact<span class="token punctuation">,</span> <span class="token operator">&amp;</span>property_info_entry<span class="token punctuation">,</span>
                               <span class="token operator">&amp;</span>parse_error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errors<span class="token operator">-&gt;</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>parse_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 插入动态数组</span>
    property_infos<span class="token operator">-&gt;</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>property_info_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>这里将传入的字符串按行分割后，将每一行的数据传入 ParsePropertyInfoLine 函数进一步解析：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token function">ParsePropertyInfoLine</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> line<span class="token punctuation">,</span> PropertyInfoEntry<span class="token operator">*</span> out<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">auto</span> tokenizer <span class="token operator">=</span> <span class="token function">SpaceTokenizer</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 解析出属性名</span>
  <span class="token keyword">auto</span> property <span class="token operator">=</span> tokenizer<span class="token punctuation">.</span><span class="token function">GetNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">&quot;Did not find a property entry in '&quot;</span> <span class="token operator">+</span> line <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
 <span class="token comment">// 解析出安全上下文</span>
  <span class="token keyword">auto</span> context <span class="token operator">=</span> tokenizer<span class="token punctuation">.</span><span class="token function">GetNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">&quot;Did not find a context entry in '&quot;</span> <span class="token operator">+</span> line <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// It is not an error to not find exact_match or a type, as older files will not contain them.</span>
  <span class="token comment">// 解析出 exact</span>
  <span class="token keyword">auto</span> exact_match <span class="token operator">=</span> tokenizer<span class="token punctuation">.</span><span class="token function">GetNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// We reformat type to be space deliminated regardless of the input whitespace for easier storage</span>
  <span class="token comment">// and subsequent parsing.</span>
  <span class="token keyword">auto</span> type_strings <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 解析出 type</span>
  <span class="token keyword">auto</span> type <span class="token operator">=</span> tokenizer<span class="token punctuation">.</span><span class="token function">GetNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    type_strings<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    type <span class="token operator">=</span> tokenizer<span class="token punctuation">.</span><span class="token function">GetNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type_strings<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">IsTypeValid</span><span class="token punctuation">(</span>type_strings<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">&quot;Type '&quot;</span> <span class="token operator">+</span> <span class="token function">Join</span><span class="token punctuation">(</span>type_strings<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;' is not valid&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 解析出的数据写入结构体</span>
  <span class="token operator">*</span>out <span class="token operator">=</span> <span class="token punctuation">{</span>property<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token function">Join</span><span class="token punctuation">(</span>type_strings<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exact_match <span class="token operator">==</span> <span class="token string">&quot;exact&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>这里将每一行的每一个数据（属性名，安全上下文，exact，类型）解析出来后，保存到 PropertyInfoEntry 结构体中，然后返回到 ParsePropertyInfoFile 函数中，将构建好的 PropertyInfoEntry 结构体插入到动态数组 vector<PropertyInfoEntry> property_infos 中。</PropertyInfoEntry></p> <p>至此，系统中所有的属性信息就保存到内存中的动态数组 vector<PropertyInfoEntry> property_infos 中了。</PropertyInfoEntry></p> <h3 id="_2-3-buildtrie-构建字典树与序列化过程分析"><a href="#_2-3-buildtrie-构建字典树与序列化过程分析" class="header-anchor">#</a> 2.3 BuildTrie 构建字典树与序列化过程分析</h3> <p>接下来程序回到 CreateSerializedPropertyInfo 函数中，接着调用 BuildTrie 函数，这个函数主要功能是把动态数组 vector&lt;PropertyInfoEntry&gt; property_infos 转换为自定义规则的序列化字符串：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">//调用过程</span>
<span class="token function">BuildTrie</span><span class="token punctuation">(</span>property_infos<span class="token punctuation">,</span> <span class="token string">&quot;u:object_r:default_prop:s0&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serialized_contexts<span class="token punctuation">,</span><span class="token operator">&amp;</span>error<span class="token punctuation">)</span>

<span class="token comment">//具体实现</span>
<span class="token keyword">bool</span> <span class="token function">BuildTrie</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PropertyInfoEntry<span class="token operator">&gt;</span><span class="token operator">&amp;</span> property_info<span class="token punctuation">,</span>
               <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> default_context<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> default_type<span class="token punctuation">,</span>
               std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> serialized_trie<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token comment">// 构建字典树</span>
  <span class="token keyword">auto</span> trie_builder <span class="token operator">=</span> <span class="token function">TrieBuilder</span><span class="token punctuation">(</span>default_context<span class="token punctuation">,</span> default_type<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 把属性名，属性的安全上下文，类型，exact 信息插入字典树</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> type<span class="token punctuation">,</span> is_exact<span class="token punctuation">]</span> <span class="token operator">:</span> property_info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trie_builder<span class="token punctuation">.</span><span class="token function">AddToTrie</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> context<span class="token punctuation">,</span> type<span class="token punctuation">,</span> is_exact<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将字典树序列化后，保存到字符串中</span>
  <span class="token keyword">auto</span> trie_serializer <span class="token operator">=</span> <span class="token function">TrieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>serialized_trie <span class="token operator">=</span> trie_serializer<span class="token punctuation">.</span><span class="token function">SerializeTrie</span><span class="token punctuation">(</span>trie_builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>BuildTrie 主要执行了以下这些操作：</p> <ul><li>通过 TrieBuilder 对象构建一个用于保存属性信息的字典树</li> <li>调用 AddToTrie 函数，向字典树中添加数据</li> <li>通过 TrieSerializer 对象的 SerializeTrie 函数将字典树序列化后保存在字符串中</li></ul> <p>我们分步看一下代码的具体实现：</p> <p>先看下 TrieBuilder 的定义与实现：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">TrieBuilder</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">TrieBuilder</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> default_context<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> default_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> <span class="token function">AddToTrie</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> context<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> type<span class="token punctuation">,</span>
                 <span class="token keyword">bool</span> exact<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> TrieBuilderNode <span class="token function">builder_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> builder_root_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">contexts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> contexts_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">types</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> types_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">bool</span> <span class="token function">AddToTrie</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> type<span class="token punctuation">,</span>
                 <span class="token keyword">bool</span> exact<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> <span class="token function">StringPointerFromContainer</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> string<span class="token punctuation">,</span>
                                                std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token operator">*</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//字典树的根节点</span>
  TrieBuilderNode builder_root_<span class="token punctuation">;</span> 
  std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> contexts_<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> types_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>从 TrieBuilder 的名字就可以看出，该类用于构建一个字典树，其成员：</p> <ul><li><code>TrieBuilderNode builder_root_</code> 是字典树的根节点</li> <li><code>std::set&lt;std::string&gt; contexts_</code> 用于保存属性对应的安全上下文信息，所有属性的安全上下文都会保存在这里，字典树中的子节点可以保存一个 index 索引值即可，当需要使用安全上下文时，通过这个 index 索引值就可以在这个 set 中找到了</li> <li><code>std::set&lt;std::string&gt; types_</code> 用于保存属性对应的类型信息，所有属性的类型信息都会保存在这里，字典树中的子节点可以保存一个 index 索引值即可，当需要使用类型信息时，通过这个 index 索引值就可以在这个 set 中找到了</li></ul> <p>接下来，我们就可以来看 TrieBuilder 构造函数的实现了：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// TrieBuilder 构造函数实现</span>

<span class="token comment">//传入的两个参数是 &quot;u:object_r:default_prop:s0&quot;, &quot;string&quot;</span>
<span class="token class-name">TrieBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">TrieBuilder</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> default_context<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> default_type<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">builder_root_</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//初始化根节点</span>
  <span class="token keyword">auto</span><span class="token operator">*</span> context_pointer <span class="token operator">=</span> <span class="token function">StringPointerFromContainer</span><span class="token punctuation">(</span>default_context<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contexts_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  builder_root_<span class="token punctuation">.</span><span class="token function">set_context</span><span class="token punctuation">(</span>context_pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span><span class="token operator">*</span> type_pointer <span class="token operator">=</span> <span class="token function">StringPointerFromContainer</span><span class="token punctuation">(</span>default_type<span class="token punctuation">,</span> <span class="token operator">&amp;</span>types_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  builder_root_<span class="token punctuation">.</span><span class="token function">set_type</span><span class="token punctuation">(</span>type_pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>首先这里初始化了字典树根节点 <code>builder_root_(&quot;root&quot;)</code>, TrieBuilderNode 的整体结构如下：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">TrieBuilderNode</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">TrieBuilderNode</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">property_entry_</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">//......</span>

  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> property_entry_<span class="token punctuation">.</span>name<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> <span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> property_entry_<span class="token punctuation">.</span>context<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">set_context</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span> property_entry_<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> property_entry_<span class="token punctuation">.</span>type<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span> property_entry_<span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">const</span> PropertyEntryBuilder <span class="token function">property_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> property_entry_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>TrieBuilderNode<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> children_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PropertyEntryBuilder<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">prefixes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> prefixes_<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PropertyEntryBuilder<span class="token operator">&gt;</span><span class="token operator">&amp;</span> <span class="token function">exact_matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> exact_matches_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// 用于保存节点的数据节点数据</span>
  PropertyEntryBuilder property_entry_<span class="token punctuation">;</span>
  <span class="token comment">// 当前节点的子节点</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>TrieBuilderNode<span class="token operator">&gt;</span> children_<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PropertyEntryBuilder<span class="token operator">&gt;</span> prefixes_<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PropertyEntryBuilder<span class="token operator">&gt;</span> exact_matches_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>其中成员 <code>PropertyEntryBuilder property_entry_</code> 用于保存节点信息：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">PropertyEntryBuilder</span> <span class="token punctuation">{</span>
  <span class="token function">PropertyEntryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">context</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">PropertyEntryBuilder</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> context<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> type<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">name</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">context</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">type</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">;</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> context<span class="token punctuation">;</span>
  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>每个节点都保存了属性的名字，安全上下文和类型信息。</p> <p>TrieBuilderNode 构造函数主要是初始化了其成员 <code>PropertyEntryBuilder property_entry_</code>，初始化时传入了一个参数 name，保存在 <code>PropertyEntryBuilder</code> 对象的 name 成员中。</p> <p>在 <code>TrieBuilder</code> 的构造函数中，接着调用 <code>StringPointerFromContainer</code> 函数将安全上下文信息 <code>&quot;u:object_r:default_prop:s0&quot;</code> 保存到 TrieBuilder 的成员 <code>std::set&lt;std::string&gt; contexts_</code> 中：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> <span class="token class-name">TrieBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">StringPointerFromContainer</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> string<span class="token punctuation">,</span>
                                                           std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token operator">*</span> container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> <span class="token punctuation">[</span>iterator<span class="token punctuation">,</span> _<span class="token punctuation">]</span> <span class="token operator">=</span> container<span class="token operator">-&gt;</span><span class="token function">emplace</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>iterator<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>接着会调用 <code>TrieBuilderNode builder_root_</code> 根节点的 set_context 函数，将安全上下文信息保存到根节点中。</p> <p>最后同样的手法，将 type 信息保存到根节点中。</p> <p>至此，对于根节点的构造就分析就完了，相关的类结构如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages/img/20231027155755.png" alt=""></p> <p>接下来就会通过 AddToTrie 函数将动态数组 <code>vector&lt;PropertyInfoEntry&gt; property_infos</code> 中的信息保存到字典树中：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">TrieBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">AddToTrie</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> context<span class="token punctuation">,</span>
                            <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> type<span class="token punctuation">,</span> <span class="token keyword">bool</span> exact<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 首先把 context 和 type 保存到 TrieBuilder 的两个集合成员中</span>
  <span class="token keyword">auto</span><span class="token operator">*</span> context_pointer <span class="token operator">=</span> <span class="token function">StringPointerFromContainer</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contexts_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span><span class="token operator">*</span> type_pointer <span class="token operator">=</span> <span class="token function">StringPointerFromContainer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token operator">&amp;</span>types_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 接着把这些信息插入字典树</span>
  <span class="token keyword">return</span> <span class="token function">AddToTrie</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> context_pointer<span class="token punctuation">,</span> type_pointer<span class="token punctuation">,</span> exact<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接下来就来看看 AddToTrie 具体插入数据的过程：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// 假设要插入的数据是 audio.camerasound.force u:object_r:exported_audio_prop:s0 exact bool</span>
<span class="token keyword">bool</span> <span class="token class-name">TrieBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">AddToTrie</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> context<span class="token punctuation">,</span>
                            <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> type<span class="token punctuation">,</span> <span class="token keyword">bool</span> exact<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 拿到根节点</span>
  TrieBuilderNode<span class="token operator">*</span> current_node <span class="token operator">=</span> <span class="token operator">&amp;</span>builder_root_<span class="token punctuation">;</span>
 
  <span class="token comment">// 将属性名分割开</span>
  <span class="token comment">// 返回的类型是 vector&lt;std::string&gt;</span>
  <span class="token keyword">auto</span> name_pieces <span class="token operator">=</span> <span class="token function">Split</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 判断属性是否以点结束</span>
  <span class="token keyword">bool</span> ends_with_dot <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name_pieces<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ends_with_dot <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    name_pieces<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Move us to the final node that we care about, adding incremental nodes if necessary.</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>name_pieces<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 注意这里是大于 1，会留一个数据 force</span>
    <span class="token comment">//在字典树中查找</span>
    <span class="token keyword">auto</span> child <span class="token operator">=</span> current_node<span class="token operator">-&gt;</span><span class="token function">FindChild</span><span class="token punctuation">(</span>name_pieces<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//没有找到就添加进字典树</span>
      child <span class="token operator">=</span> current_node<span class="token operator">-&gt;</span><span class="token function">AddChild</span><span class="token punctuation">(</span>name_pieces<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">&quot;Unable to allocate Trie node&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    current_node <span class="token operator">=</span> child<span class="token punctuation">;</span>
    name_pieces<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>name_pieces<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    <span class="token comment">// 省略后续代码</span>
    <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><ul><li>属性名分割开，保存到 <code>vector&lt;std::string&gt; name_pieces</code> 中</li> <li>根据分割后的名字在字典树中查找节点</li> <li>没有找到就向字典树添加新的节点</li></ul> <p>接下来就看看字典树的查找与插入操作：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  TrieBuilderNode<span class="token operator">*</span> <span class="token function">FindChild</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> child <span class="token operator">:</span> children_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> name<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  TrieBuilderNode<span class="token operator">*</span> <span class="token function">AddChild</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>children_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>查找操作就是从当前节点的子节点中遍历查找，插入操作就是在子节点动态数组中插入一个新节点。</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">bool</span> <span class="token class-name">TrieBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">AddToTrie</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> context<span class="token punctuation">,</span>
                            <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> type<span class="token punctuation">,</span> <span class="token keyword">bool</span> exact<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// 接上面的代码</span>
    <span class="token comment">// ......</span>
  <span class="token comment">// Store our context based on what type of match it is.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>exact<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 走这里，有 exact 表示是一个目标节点，代表一个属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current_node<span class="token operator">-&gt;</span><span class="token function">AddExactMatchContext</span><span class="token punctuation">(</span>name_pieces<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">&quot;Duplicate exact match detected for '&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ends_with_dot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>current_node<span class="token operator">-&gt;</span><span class="token function">AddPrefixContext</span><span class="token punctuation">(</span>name_pieces<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">&quot;Duplicate prefix match detected for '&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> child <span class="token operator">=</span> current_node<span class="token operator">-&gt;</span><span class="token function">FindChild</span><span class="token punctuation">(</span>name_pieces<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      child <span class="token operator">=</span> current_node<span class="token operator">-&gt;</span><span class="token function">AddChild</span><span class="token punctuation">(</span>name_pieces<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">&quot;Unable to allocate Trie node&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token operator">-&gt;</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">||</span> child<span class="token operator">-&gt;</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">*</span>error <span class="token operator">=</span> <span class="token string">&quot;Duplicate prefix match detected for '&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    child<span class="token operator">-&gt;</span><span class="token function">set_context</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    child<span class="token operator">-&gt;</span><span class="token function">set_type</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>有 exact 表示是一个目标节点，代表一个属性：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>  <span class="token keyword">bool</span> <span class="token function">AddExactMatchContext</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> exact_match<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> context<span class="token punctuation">,</span>
                            <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">find_if</span><span class="token punctuation">(</span>exact_matches_<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exact_matches_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>exact_match<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> t<span class="token punctuation">.</span>name <span class="token operator">==</span> exact_match<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">!=</span> exact_matches_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    exact_matches_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>exact_match<span class="token punctuation">,</span> context<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>当遇到 exact 时，不会创建新的节点，而是在最后一个节点内部的 exact 数组中插入一个新的 PropertyEntryBuilder 对象。</p> <p>整个字典树的构造过程分析就结束了，至此，字典树的结构如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages/img/20231027210701.png" alt=""></p> <p>接下来分析对字典树的序列化操作：</p> <p>调用过程：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">auto</span> trie_serializer <span class="token operator">=</span> <span class="token function">TrieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span>serialized_trie <span class="token operator">=</span> trie_serializer<span class="token punctuation">.</span><span class="token function">SerializeTrie</span><span class="token punctuation">(</span>trie_builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里使用 TrieSerializer 对象来进行序列化操作：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">TrieSerializer</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">TrieSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token double-colon punctuation">::</span>string <span class="token function">SerializeTrie</span><span class="token punctuation">(</span><span class="token keyword">const</span> TrieBuilder<span class="token operator">&amp;</span> trie_builder<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">SerializeStrings</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token operator">&amp;</span> strings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> <span class="token function">WritePropertyEntry</span><span class="token punctuation">(</span><span class="token keyword">const</span> PropertyEntryBuilder<span class="token operator">&amp;</span> property_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Writes a new TrieNode to arena, and recursively writes its children.</span>
  <span class="token comment">// Returns the offset within arena.</span>
  <span class="token keyword">uint32_t</span> <span class="token function">WriteTrieNode</span><span class="token punctuation">(</span><span class="token keyword">const</span> TrieBuilderNode<span class="token operator">&amp;</span> builder_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> PropertyInfoArea<span class="token operator">*</span> <span class="token function">serialized_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> PropertyInfoArea<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>arena_<span class="token operator">-&gt;</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>TrieNodeArena<span class="token operator">&gt;</span> arena_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>TrieSerializer 类有个重要成员 TrieNodeArena ：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">TrieNodeArena</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">TrieNodeArena</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">current_data_pointer_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// We can't return pointers to objects since data_ may move when reallocated, thus invalidating</span>
  <span class="token comment">// any pointers.  Therefore we return an ArenaObjectPointer, which always accesses elements via</span>
  <span class="token comment">// data_ + offset.</span>
  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
  ArenaObjectPointer<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">AllocateObject</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token operator">*</span> return_offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> offset<span class="token punctuation">;</span>
    <span class="token function">AllocateData</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>return_offset<span class="token punctuation">)</span> <span class="token operator">*</span>return_offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">ArenaObjectPointer</span><span class="token generic class-name"><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data_<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> <span class="token function">AllocateUint32Array</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> offset<span class="token punctuation">;</span>
    <span class="token function">AllocateData</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span> <span class="token operator">*</span> length<span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> offset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span><span class="token operator">*</span> <span class="token function">uint32_array</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> <span class="token function">AllocateAndWriteString</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> offset<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> data <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">AllocateData</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> offset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">AllocateAndWriteUint32</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> location <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">AllocateData</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>location <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">AllocateData</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span><span class="token operator">*</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//4字节对齐</span>
    size_t aligned_size <span class="token operator">=</span> size <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>current_data_pointer_ <span class="token operator">+</span> aligned_size <span class="token operator">&gt;</span> data_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">auto</span> new_size <span class="token operator">=</span> <span class="token punctuation">(</span>current_data_pointer_ <span class="token operator">+</span> aligned_size <span class="token operator">+</span> data_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
      data_<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>new_size<span class="token punctuation">,</span> <span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset<span class="token punctuation">)</span> <span class="token operator">*</span>offset <span class="token operator">=</span> current_data_pointer_<span class="token punctuation">;</span>

    <span class="token keyword">uint32_t</span> return_offset <span class="token operator">=</span> current_data_pointer_<span class="token punctuation">;</span>
    current_data_pointer_ <span class="token operator">+=</span> aligned_size<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>data_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> return_offset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">uint32_t</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> current_data_pointer_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> data_<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  std<span class="token double-colon punctuation">::</span>string <span class="token function">truncated_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> result <span class="token operator">=</span> data_<span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>current_data_pointer_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span> 
  std<span class="token double-colon punctuation">::</span>string data_<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> current_data_pointer_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>从源码可以看出 TrieNodeArena 是一个工具类，用于从内部的 <code>std::string data_</code> 字符串中分配一块内存给外部使用。</p> <p>接下来，我们就来看看 SerializeTrie 函数进行字典树序列化的过程：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>std<span class="token double-colon punctuation">::</span>string <span class="token class-name">TrieSerializer</span><span class="token double-colon punctuation">::</span><span class="token function">SerializeTrie</span><span class="token punctuation">(</span><span class="token keyword">const</span> TrieBuilder<span class="token operator">&amp;</span> trie_builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  arena_<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">TrieNodeArena</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 分配一块 PropertyInfoAreaHeader 内存 </span>
  <span class="token keyword">auto</span> header <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">AllocateObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>PropertyInfoAreaHeader<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  header<span class="token operator">-&gt;</span>current_version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  header<span class="token operator">-&gt;</span>minimum_supported_version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// Store where we're about to write the contexts.</span>
  
  <span class="token comment">// 序列化安全上下文</span>
  header<span class="token operator">-&gt;</span>contexts_offset <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SerializeStrings</span><span class="token punctuation">(</span>trie_builder<span class="token punctuation">.</span><span class="token function">contexts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 序列化类型信息</span>
  <span class="token comment">// Store where we're about to write the types.</span>
  header<span class="token operator">-&gt;</span>types_offset <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SerializeStrings</span><span class="token punctuation">(</span>trie_builder<span class="token punctuation">.</span><span class="token function">types</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 序列化字典树</span>
  <span class="token comment">// We need to store size() up to this point now for Find*Offset() to work.</span>
  header<span class="token operator">-&gt;</span>size <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> root_trie_offset <span class="token operator">=</span> <span class="token function">WriteTrieNode</span><span class="token punctuation">(</span>trie_builder<span class="token punctuation">.</span><span class="token function">builder_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  header<span class="token operator">-&gt;</span>root_offset <span class="token operator">=</span> root_trie_offset<span class="token punctuation">;</span>

  <span class="token comment">// Record the real size now that we've written everything</span>
  header<span class="token operator">-&gt;</span>size <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> arena_<span class="token operator">-&gt;</span><span class="token function">truncated_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>从 <code>SerializeTrie</code> 函数主要完成四件件事：</p> <ul><li>在序列化字符串 <code>std::string data_</code>  中分配一块 PropertyInfoAreaHeader 内存</li> <li>将所有的安全上下文序列化后存入 <code>std::string data_</code></li> <li>将所有的类型信息序列化后存入 <code>std::string data_</code></li> <li>将字典树序列化后存入 <code>std::string data_</code></li></ul> <p>序列化后的字符串的基本结构如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages/img/20231029105758.png" alt=""></p> <p>接着我们一一分析每类数据的序列化过程：</p> <p>字符串数据的序列化过程：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token comment">// PropertyInfoAreaHeader 对象序列化过程</span>

<span class="token comment">// std::set&lt;std::string&gt; 序列化过程</span>
<span class="token keyword">void</span> <span class="token class-name">TrieSerializer</span><span class="token double-colon punctuation">::</span><span class="token function">SerializeStrings</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>set<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span><span class="token operator">&amp;</span> strings<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 先写入字符串长度</span>
  arena_<span class="token operator">-&gt;</span><span class="token function">AllocateAndWriteUint32</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 分配一个数组记录每个字符串的位置</span>
  <span class="token comment">// Allocate space for the array.</span>
  <span class="token keyword">uint32_t</span> offset_array_offset <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token function">AllocateUint32Array</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 写入字符串与偏移位置</span>
  <span class="token keyword">auto</span> it <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> strings<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> string_offset <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token function">AllocateAndWriteString</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
    arena_<span class="token operator">-&gt;</span><span class="token function">uint32_array</span><span class="token punctuation">(</span>offset_array_offset<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> string_offset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>从源码中可以看出来，序列化一个字符串集合分为以下几步：</p> <ul><li>分配一块内存，写入字符串长度</li> <li>分配一块数组内存，用于保存每个字符串的位置</li> <li>分配内存写入每个字符串，并在上一步的数组中记录字符串的位置信息</li></ul> <p>字典树的序列化会复杂一些:</p> <p>以下代码，是字典树节点的结构：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">class</span> <span class="token class-name">TrieBuilderNode</span> <span class="token punctuation">{</span>
 <span class="token comment">// ......</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token comment">// 用于保存节点的数据节点数据</span>
  PropertyEntryBuilder property_entry_<span class="token punctuation">;</span>
  <span class="token comment">// 当前节点的子节点</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>TrieBuilderNode<span class="token operator">&gt;</span> children_<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PropertyEntryBuilder<span class="token operator">&gt;</span> prefixes_<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>PropertyEntryBuilder<span class="token operator">&gt;</span> exact_matches_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>字典树内部有四个成员，四个成员的结构都相对复杂，我们看下源码是怎么来序列化字典树节点的：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">uint32_t</span> <span class="token class-name">TrieSerializer</span><span class="token double-colon punctuation">::</span><span class="token function">WriteTrieNode</span><span class="token punctuation">(</span><span class="token keyword">const</span> TrieBuilderNode<span class="token operator">&amp;</span> builder_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint32_t</span> trie_offset<span class="token punctuation">;</span>
  <span class="token keyword">auto</span> trie <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">AllocateObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>TrieNodeInternal<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trie_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//序列化并写入 property_entry_ 对象</span>
  trie<span class="token operator">-&gt;</span>property_entry <span class="token operator">=</span> <span class="token function">WritePropertyEntry</span><span class="token punctuation">(</span>builder_node<span class="token punctuation">.</span><span class="token function">property_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token comment">//排序后，序列化并写入 prefixes_ 动态数组</span>
  <span class="token keyword">auto</span> sorted_prefix_matches <span class="token operator">=</span> builder_node<span class="token punctuation">.</span><span class="token function">prefixes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>sorted_prefix_matches<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sorted_prefix_matches<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> lhs<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> rhs<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  trie<span class="token operator">-&gt;</span>num_prefixes <span class="token operator">=</span> sorted_prefix_matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> prefix_entries_array_offset <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token function">AllocateUint32Array</span><span class="token punctuation">(</span>sorted_prefix_matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  trie<span class="token operator">-&gt;</span>prefix_entries <span class="token operator">=</span> prefix_entries_array_offset<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sorted_prefix_matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> property_entry_offset <span class="token operator">=</span> <span class="token function">WritePropertyEntry</span><span class="token punctuation">(</span>sorted_prefix_matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    arena_<span class="token operator">-&gt;</span><span class="token function">uint32_array</span><span class="token punctuation">(</span>prefix_entries_array_offset<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> property_entry_offset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 排序后，序列化并写入 prefixes_ 动态数组</span>
  <span class="token keyword">auto</span> sorted_exact_matches <span class="token operator">=</span> builder_node<span class="token punctuation">.</span><span class="token function">exact_matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>sorted_exact_matches<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sorted_exact_matches<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> lhs<span class="token punctuation">.</span>name <span class="token operator">&lt;</span> rhs<span class="token punctuation">.</span>name<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  trie<span class="token operator">-&gt;</span>num_exact_matches <span class="token operator">=</span> sorted_exact_matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">uint32_t</span> exact_match_entries_array_offset <span class="token operator">=</span>
      arena_<span class="token operator">-&gt;</span><span class="token function">AllocateUint32Array</span><span class="token punctuation">(</span>sorted_exact_matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  trie<span class="token operator">-&gt;</span>exact_match_entries <span class="token operator">=</span> exact_match_entries_array_offset<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sorted_exact_matches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint32_t</span> property_entry_offset <span class="token operator">=</span> <span class="token function">WritePropertyEntry</span><span class="token punctuation">(</span>sorted_exact_matches<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    arena_<span class="token operator">-&gt;</span><span class="token function">uint32_array</span><span class="token punctuation">(</span>exact_match_entries_array_offset<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> property_entry_offset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//排序后，序列化并写入 children_动态数组</span>
  <span class="token keyword">auto</span> sorted_children <span class="token operator">=</span> builder_node<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span><span class="token function">sort</span><span class="token punctuation">(</span>sorted_children<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sorted_children<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> lhs<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> lhs<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> rhs<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  trie<span class="token operator">-&gt;</span>num_child_nodes <span class="token operator">=</span> sorted_children<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> children_offset_array_offset <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token function">AllocateUint32Array</span><span class="token punctuation">(</span>sorted_children<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  trie<span class="token operator">-&gt;</span>child_nodes <span class="token operator">=</span> children_offset_array_offset<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sorted_children<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    arena_<span class="token operator">-&gt;</span><span class="token function">uint32_array</span><span class="token punctuation">(</span>children_offset_array_offset<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">WriteTrieNode</span><span class="token punctuation">(</span>sorted_children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> trie_offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>WriteTrieNode 函数总共四个流程：</p> <ul><li>序列化并向内存中写入 property_entry_ 对象</li> <li>排序后，序列化并向内存中写入 prefixes_ 动态数组</li> <li>排序后，序列化并向内存中写入 prefixes_ 动态数组</li> <li>排序后，递归调用 WriteTrieNode 函数将 children_ 动态数组序列化后写入内存</li></ul> <p>流程很多，但是核心就是 WritePropertyEntry 函数，将 PropertyEntryBuilder 结构体序列化后，写入内存：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">uint32_t</span> <span class="token class-name">TrieSerializer</span><span class="token double-colon punctuation">::</span><span class="token function">WritePropertyEntry</span><span class="token punctuation">(</span><span class="token keyword">const</span> PropertyEntryBuilder<span class="token operator">&amp;</span> property_entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 从上面的动态数组里找到索引</span>
  <span class="token keyword">uint32_t</span> context_index <span class="token operator">=</span> property_entry<span class="token punctuation">.</span>context <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>property_entry<span class="token punctuation">.</span>context<span class="token operator">-&gt;</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                               <span class="token operator">?</span> <span class="token function">serialized_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">FindContextIndex</span><span class="token punctuation">(</span>property_entry<span class="token punctuation">.</span>context<span class="token operator">-&gt;</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                               <span class="token operator">:</span> <span class="token operator">~</span><span class="token number">0u</span><span class="token punctuation">;</span>
  <span class="token comment">// 从上面的动态数组里找到索引</span>
  <span class="token keyword">uint32_t</span> type_index <span class="token operator">=</span> property_entry<span class="token punctuation">.</span>type <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>property_entry<span class="token punctuation">.</span>type<span class="token operator">-&gt;</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">?</span> <span class="token function">serialized_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">FindTypeIndex</span><span class="token punctuation">(</span>property_entry<span class="token punctuation">.</span>type<span class="token operator">-&gt;</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token operator">:</span> <span class="token operator">~</span><span class="token number">0u</span><span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> offset<span class="token punctuation">;</span>
  <span class="token keyword">auto</span> serialized_property_entry <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">AllocateObject</span><span class="token generic class-name"><span class="token operator">&lt;</span>PropertyEntry<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  serialized_property_entry<span class="token operator">-&gt;</span>name_offset <span class="token operator">=</span> arena_<span class="token operator">-&gt;</span><span class="token function">AllocateAndWriteString</span><span class="token punctuation">(</span>property_entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  serialized_property_entry<span class="token operator">-&gt;</span>namelen <span class="token operator">=</span> property_entry<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  serialized_property_entry<span class="token operator">-&gt;</span>context_index <span class="token operator">=</span> context_index<span class="token punctuation">;</span>
  serialized_property_entry<span class="token operator">-&gt;</span>type_index <span class="token operator">=</span> type_index<span class="token punctuation">;</span>
  <span class="token keyword">return</span> offset<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>函数中的 serialized_info() 返回的是 TrieNodeArena 管理对象内部的 data_ 字符串，内部保存了我们准备序列化的整个数据，其中包含了序列化后的所有的安全上下文集合 <code>std::set&lt;std::string contexts_</code> 和所有的类型信息集合 <code>std::set&lt;std::string types_</code>。</p> <p>PropertyEntryBuilder 结构体中有 context 和 type，我们只需要再上面的集合中找到它们对应的 index 索引值，然后保存到目标序列化字符串中即可。</p> <p>这里分配了一个 PropertyEntry 对象，用于序列化上面的 PropertyEntryBuilder 对象：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">PropertyEntry</span> <span class="token punctuation">{</span>
  <span class="token keyword">uint32_t</span> name_offset<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> namelen<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> context_index<span class="token punctuation">;</span>
  <span class="token keyword">uint32_t</span> type_index<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>接着写入 PropertyEntryBuilder 对象的 name，并把 name 的偏移值和长度保存在 PropertyEntry 的 name_offset 和 namelen 中。最有把 context 和 type 的偏移值保存到 context_index 和 type_index 中。</p> <p>至此整个 BuildTrie 过程就分析完了，过程很繁琐，完成的工作其实很简单，构建一个保存属性信息的字典树，并将其序列化后，保存到一个 std::string 字符串中.</p> <p>所有的属性相关的信息都序列化完成，接下来就要把他写入文件了：</p> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">CreateSerializedPropertyInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ......</span>
  
    <span class="token comment">//序列化后的 String 写入文件 /dev/__properties__/property_info</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> kPropertyInfosPath<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> &quot;<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteStringToFile</span><span class="token punctuation">(</span>serialized_contexts<span class="token punctuation">,</span> kPropertyInfosPath<span class="token punctuation">,</span> <span class="token number">0444</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;Unable to write serialized property infos to file&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">selinux_android_restorecon</span><span class="token punctuation">(</span>kPropertyInfosPath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在 CreateSerializedPropertyInfo 函数的最后部分，调用 WriteStringToFile 将序列化后的字符串写入 /dev/<strong>properties</strong>/property_info 文件中</p> <h2 id="关于"><a href="#关于" class="header-anchor">#</a> 关于</h2> <p>我叫阿豪，2015 年本科毕业于国防科学技术大学指挥信息系统专业，毕业后从事信息化装备的研发工作，工作内容主要涉及 Android Framework 与 Linux Kernel。</p> <p>如果你对 Android Framework 感兴趣或者正在学习 Android Framework，可以关注我的微信公众号和抖音，我会持续分享我的学习经验，帮助正在学习的你少走一些弯路。学习过程中如果你有疑问或者你的经验想要分享给大家可以添加我的微信，我拉你进技术交流群。</p> <p><img src="https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg" alt=""></p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/013.属性与 Selinux.html" class="prev">
          013.属性与 Selinux
        </a></span> <span class="next"><a href="/AndroidFrameworkTutorialPages/004.基础组件篇/015.属性系统源码分析二.html">
          015.属性系统源码分析二
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/AndroidFrameworkTutorialPages/assets/js/app.6bee58ca.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/7.4046385e.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/2.b8949bfe.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/1.1165d272.js" defer></script><script src="/AndroidFrameworkTutorialPages/assets/js/130.244b0cdc.js" defer></script>
  </body>
</html>
