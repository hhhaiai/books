(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{494:function(s,a,n){"use strict";n.r(a);var t=n(2),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"_1-工具篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-工具篇"}},[s._v("#")]),s._v(" 1. 工具篇")]),s._v(" "),a("p",[s._v("对于 Android 系统源码中的 C/C++ 代码，CLion 是一个不错的工具。")]),s._v(" "),a("p",[s._v("较新版本的 Android 源码支持使用 AIDEgen 调用 Clion 查看 C/C++ 代码。但是，对于我们学习使用的 Android10 是不支持的。不过我们可以通过其他办法实现 Clion 查看 C/C++ 代码：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 准备工作")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" build/envsetup.sh\nlunch aosp_x86_64-eng "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#选择一个合适的 Product")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SOONG_GEN_CMAKEFILES")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SOONG_GEN_CMAKEFILES_DEBUG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j16")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("接着我们就可以使用 Clion 打开我们的代码了。")]),s._v(" "),a("p",[s._v("假设我们需要看 SurfaceFlinger 相关代码:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#系统源码目录下搜索")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SurfaceFlinger*"')]),s._v("\n./frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp\n./frameworks/native/services/surfaceflinger/SurfaceFlingerProperties.cpp\n./frameworks/native/services/surfaceflinger/SurfaceFlinger.h\n./frameworks/native/services/surfaceflinger/SurfaceFlingerProperties.h\n./frameworks/native/services/surfaceflinger/SurfaceFlingerFactory.h\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("这里我们知道 SurfaceFlinger 定义在 "),a("code",[s._v("frameworks/native/services")]),s._v(" 目录:")]),s._v(" "),a("p",[s._v("接着我们打开 Clion，点击 Open：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719150958.png",alt:""}})]),s._v(" "),a("p",[s._v("选择 "),a("code",[s._v("out/development/ide/clion/frameworks/native")]),s._v(" 目录")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151009.png",alt:""}})]),s._v(" "),a("p",[s._v("这样我们就可以使用 CLion 查看系统源码了，需要注意的是我们的源码需要在 External Libraries 中查看：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151018.png",alt:""}})]),s._v(" "),a("p",[s._v("我们也可以通过点击 Change Project Root 按钮调整目录结构：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151026.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151048.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"_2-手段篇"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-手段篇"}},[s._v("#")]),s._v(" 2. 手段篇")]),s._v(" "),a("p",[s._v("阅读源码主要两个手段：")]),s._v(" "),a("ul",[a("li",[s._v("打印 Log + 打印调用堆栈")]),s._v(" "),a("li",[s._v("使用 CLion 调试")])]),s._v(" "),a("p",[s._v("这里我们修改 SurfaceFlinger 的主函数 main_surfaceflinger.cpp 来演示打印 Log 和打印调用堆栈：")]),s._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//log的头文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"log/log.h"')])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//直接 define LOG_TAG 会报已定义错误，因为 SurFaceFlinger 模块的 Android.bp 已经定义了 LOG_Tag")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//下面这样定义就不会出错了")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("ifdef")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[s._v("LOG_TAG")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("undef")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[s._v("LOG_TAG")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LOG_TAG")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yuandaima_sf"')])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("endif")])]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//打印堆栈的头文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token macro property"}},[a("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("<utils/CallStack.h>")])]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//在 main 函数中打印信息")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("char")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//打印日志")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ALOGD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"surfaceflinger is starting"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//打印堆栈")]),s._v("\n    android"),a("span",{pre:!0,attrs:{class:"token double-colon punctuation"}},[s._v("::")]),s._v("CallStack "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("callStack")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("LOG_TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//省略后面的代码")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//......")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("修改 /frameworks/native/services/surfaceflinger/Android.bp,添加 CallStack 的库依赖：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151111.png",alt:""}})]),s._v(" "),a("p",[s._v("接着我们重新编译代码，启动模拟器，进入 adb shell，查看 log：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("rice14:/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# logcat | grep yuandaima_sf")]),s._v("\n05-11 09:54:10.291  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1531")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1531")]),s._v(" D yuandaima_sf: surfaceflinger is starting\n\n05-11 09:54:10.296  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1531")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1531")]),s._v(" D yuandaima_sf: "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#00 pc 00000000000030a1  /system/bin/surfaceflinger (main+65)")]),s._v("\n05-11 09:54:10.296  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1531")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1531")]),s._v(" D yuandaima_sf: "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#01 pc 000000000008a985  /apex/com.android.runtime/lib64/bionic/libc.so (__libc_init+117)")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("通过 log 信息我们可以知道程序的运行状态和运行过程中的关键参数。通过调用栈我们可以知道函数的执行流程。")]),s._v(" "),a("p",[s._v("我们还可以通过 Clion 来调试 C/C++ 代码:")]),s._v(" "),a("p",[s._v("这里以调试 service_manager.c 为例：")]),s._v(" "),a("p",[s._v("我们在如下位置打印好断点：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151126.png",alt:""}})]),s._v(" "),a("p",[s._v("接着配置远程调试：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151135.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151142.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151154.png",alt:""}})]),s._v(" "),a("p",[s._v("这样我们的 Clion 就配置好了。")]),s._v(" "),a("p",[s._v("接着我们查看 servicemanage 进程的 pid：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb shell "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" servicemanager \nsystem        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1406")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14116")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5532")]),s._v(" binder_ioctl        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" S servicemanager\nsystem        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1407")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21764")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9772")]),s._v(" SyS_epoll_wait      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" S hwservicemanager\nsystem        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1408")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14816")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2584")]),s._v(" binder_ioctl        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" S vndservicemanage\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("servicemanager 的 pid 为 1406，接着在模拟器上开启 gdbserver：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("adb forward tcp:1235 tcp:1235\nadb shell gdbserver64 :1235 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--attach")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1406")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("接着点击 Clion 右上角的 debug 按钮就进入 debug 环境了：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/20230719151204.png",alt:""}})]),s._v(" "),a("p",[s._v("这样我们就可以开始调试 C/C++ 代码了。")]),s._v(" "),a("h2",{attrs:{id:"关于"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于"}},[s._v("#")]),s._v(" 关于")]),s._v(" "),a("p",[s._v("我叫阿豪，2015 年本科毕业于国防科学技术大学指挥信息系统专业，毕业后从事信息化装备的研发工作，主要研究方向是 Android Framework 与 Linux Kernel。")]),s._v(" "),a("p",[s._v("如果你对 Android Framework 感兴趣或者正在学习 Android Framework，可以关注我的微信公众号和抖音，我会持续分享我的学习经验，帮助正在学习的你少走一些弯路。学习过程中如果你有疑问或者你的经验想要分享给大家可以添加我的微信，我拉你进技术交流群。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zzh0838/MyImages@main/img/%E4%BA%8C%E7%BB%B4%E7%A0%81.jpg",alt:""}})])])}),[],!1,null,null,null);a.default=e.exports}}]);